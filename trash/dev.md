| Экран/Сущность   | Поле                                   | Тип/Формат | Обяз. | Правила                                           | Регэкс/маска           | Нормализация          | Зависимости                     | Ошибка                    | Примеры          |
| ---------------- | -------------------------------------- | ---------- | ----- | ------------------------------------------------- | ---------------------- | --------------------- | ------------------------------- | ------------------------- | ---------------- |
| Person           | `last_name`/`first_name`/`middle_name` | string     | да    | 1–100, буквы, дефис, пробел                       | `^[\p{L}\- ]{1,100}$`  | trim, collapse spaces | —                               | «Некорректное имя»        | ok: «Анна-Мария» |
| Person           | `status`                               | enum       | да    | {Lead, EmployeeOfLegal, EmployeeOfIE, Individual} | —                      | —                     | влияет на доступные действия    | «Статус недопустим»       | —                |
| Person           | `login`                                | string     | усл.  | min 6; лат/циф/.\_-; уникальность                 | `^[A-Za-z0-9._-]{6,}$` | lower                 | обяз. если `isEmployeeKVS=true` | «Логин занят/некорректен» | ok: `ivanov_aa`  |

| Роль \ Ресурс  | view | create |         update | delete | Scope        |
| -------------- | ---: | -----: | -------------: | -----: | ------------ |
| AdminKVS       |    ✓ |      ✓ |              ✓ |      ✓ | org/global   |
| AdminKPS       |    ✓ |      ✓ |              ✓ |      ✓ | org          |
| Manager        |    ✓ |      ✓ |              ✓ |      ✗ | team/org     |
| Support        |    ✓ |      ✗ | ✓ (ограничено) |      ✗ | org          |
| Viewer         |    ✓ |      ✗ |              ✗ |      ✗ | org          |
| ServiceAccount |    ✓ |      ✓ |              ✓ |      ✗ | по контракту |

| Ресурс          | Поле            | Описание         | AdminKVS: видит | ред. | Manager: видит | ред. | Правила                               |
| --------------- | --------------- | ---------------- | --------------- | ---: | -------------- | ---: | ------------------------------------- |
| Person          | `status`        | статус           | ✓               |    ✓ | ✓              |    ✓ | изменение статуса только при `Active` |
| Person          | `login`         | учётный логин    | ✓               |    ✓ | ✓              |    ✗ | только Admin\*                        |
| Person          | `created_at/by` | авто             | ✓               |    ✗ | ✓              |    ✗ | read-only всегда                      |
| Contact         | `is_primary`    | основной         | ✓               |    ✓ | ✓              |    ✓ | единственность по типу                |
| PersonLegalLink | `is_primary`    | основное юр.лицо | ✓               |    ✓ | ✓              |    ✓ | ровно одно                            |











| From → To                                          | Документ-основание    | Ключевые проверки                                                                                 | Автодействия                                                              |
|----------------------------------------------------|-----------------------|---------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------|
| На складе → Выдано под отчёт                       | `issue_doc_id`        | Свободно (не в ремонте/утиле), `warehouse_id` заполнен до перехода                                | Снять `warehouse_id`, проставить `employee_id`                            |
| Выдано под отчёт → На складе                       | `return_doc_id`       | Совпадение единицы, нет открытой установки/ремонта                                                | Проставить `warehouse_id`, очистить `employee_id`                         |
| На складе → У заказчика                            | `consign_doc_id`      | Контрагент активен, лимиты консигнации                                                            | Снять `warehouse_id`, проставить `client_id`                              |
| У заказчика → На складе                            | `return_doc_id`       | Проверка комплектности (всё возвращено)                                                           | Проставить `warehouse_id`, очистить `client_id`                           |
| (На складе \| Выдано \| У заказчика) → Установлено | `installation_act_id` | Нет статуса «Рекламация/Утиль», ТС активно; для комплектов — все обязательные компоненты доступны | Установить `vehicle_id`, `installed_at`, автозадать СКЗИ (если применимо) |
| Установлено → На складе                            | `demount_act_id`      | Демонтаж разрешён; закрыть зависимые СКЗИ/гарантийные таймеры, если логика требует                | Очистить `vehicle_id`, `installed_at`, рассчитать остаточную гарантию     |
| На складе → Продано                                | `sales_doc_id`        | Привязка к покупателю, количество = 1, цены/скидки валидны                                        | Финальное списание; запрет дальнейших переходов кроме «Возврат»           |
| Продано → На складе (Возврат)                      | `sales_return_doc_id` | Срок/условия возврата; состояние приемлемо                                                        | Восстановление остатков, статусов                                         |
| Любой → Рекламация                                 | `rma_doc_id`          | Описание дефекта, принадлежность                                                                  | Блокировать другие операции                                               |
| Рекламация → На складе                             | `rma_close_doc_id`    | Результат ремонта (исправно/замена)                                                               | При замене — новая единица, старая в «Утиль»/«На складе» по решению       |
| Любой → Утиль                                      | `scrap_doc_id`        | Комиссия/основание, комплектность закрыта                                                         | Терминальный переход                                                      |


| Статус                        | Обязательные поля                                                     | Запрещено/должно быть пусто                              | Авто-правила/побочные эффекты                                                                                   |
| ----------------------------- | --------------------------------------------------------------------- | -------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| **На складе**                 | `warehouse_id`                                                        | `employee_id`, `client_id`, `vehicle_id`, `installed_at` | При входе — проверка наличия приходного документа/основания.                                                    |
| **Выдано под отчёт (сотр.)**  | `employee_id`, `issue_doc_id`                                         | `warehouse_id`, `client_id`, `vehicle_id`                | Разрешены сроки возврата, напоминания.                                                                          |
| **У заказчика (консигнация)** | `client_id`, `consign_doc_id`                                         | `warehouse_id`, `employee_id`, `vehicle_id`              | В отчётах учитывается как «под отчёт клиенту».                                                                  |
| **Установлено**               | `vehicle_id`, `installed_at`, при необходимости `installation_act_id` | `warehouse_id`, `employee_id`, `client_id`               | Если включено СКЗИ — автозаполнение `skzi_from = installed_at`, `skzi_to = +3 года` (конфигурируемо).           |
| **Продано**                   | `sales_doc_id`, `buyer_id` (юрлицо/физлицо)                           | `warehouse_id`, `employee_id`, `client_id`, `vehicle_id` | Запрет обратных движений без «Возврата». Списывает из остатка.                                                  |
| **Рекламация (в ремонте)**    | `rma_doc_id`, `rma_vendor_id` или `service_center_id`                 | —                                                        | Место хран.: либо `warehouse_id` (ремонтный склад), либо внешний `service_center`. Блокирует установку/продажу. |
| **Утиль (списано)**           | `scrap_doc_id`, `scrap_reason`                                        | Любое местоположение                                     | Невозвратный терминальный статус.                                                                               |


| Поле           | Правило                                                    | Сообщение об ошибке (пример)                           |
| -------------- | ---------------------------------------------------------- | ------------------------------------------------------ |
| `serial`       | Не пусто, длина ≤ 64, уникальность (скоуп)                 | «Серийный номер обязателен и должен быть уникальным.»  |
| `imei`         | 14–16 цифр, Luhn-проверка (если включено)                  | «IMEI имеет неверный формат.»                          |
| `iccid`        | 19–22 цифры                                                | «ICCID имеет неверный формат.»                         |
| `mac`          | `HH:HH:HH:HH:HH:HH` или `HH-HH-…`                          | «MAC-адрес некорректен.»                               |
| `installed_at` | `installed_at >= received_at` и ≤ сегодня                  | «Дата монтажа раньше даты поступления/в будущем.»      |
| `warranty_end` | `>= warranty_start`                                        | «Дата окончания гарантии не может быть раньше начала.» |
| `warehouse_id` | Обязателен, если статус «На складе»/«Рекламация на складе» | «Не указан склад для статуса “На складе”.»             |
| `employee_id`  | Обязателен, если «Выдано под отчёт»                        | «Не указан сотрудник при выдаче под отчёт.»            |
| `client_id`    | Обязателен, если «У заказчика»                             | «Не указан заказчик для консигнации.»                  |
| `vehicle_id`   | Обязателен, если «Установлено»                             | «Не указано ТС для установленного оборудования.»       |
| `skzi_*`       | Включать/валидировать только для соответствующих продуктов | «Поля СКЗИ доступны лишь для СКЗИ-оборудования.»       |


